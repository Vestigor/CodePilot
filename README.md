# CodePilot - IntelliJ IDEA 智能教学助手插件

## 📚 项目概述

CodePilot 是一个先进的 IntelliJ IDEA 插件，作为 Java 企业应用开发课程的智能教学助手。该插件利用大型语言模型（LLM）结合检索增强生成（RAG）技术，提供上下文感知的编码辅助、自动代码生成和智能开发工具。

**小组：** B  
**需求：** F0（基础功能）+ F1（扩展功能）

## ✨ 核心功能

### F0：基础功能

#### 1. **基于 RAG 的问答聊天机器人（带源引用）** 🤖
- **智能课程材料处理**：自动处理和索引课程材料（PDF 讲义、DOCX 文档、PPTX 演示文稿）
- **智能知识分块**：将文档分解为可搜索的块，具有页面级粒度
- **基于向量的语义搜索**：使用嵌入模型根据语义相似性找到最相关的内容
- **源引用系统**：每个响应都清楚地引用源文档和页码
  - 格式：`【来源：讲义名称.pdf - 第 X 页】`
  - 当答案基于通用知识时明确通知
- **持久化知识库**：缓存带有嵌入的已处理文档，实现即时启动

#### 2. **用户友好的聊天界面** 💬
- **嵌入式工具窗口**：原生 IntelliJ IDEA 工具窗口，现代化 UI 设计
- **Markdown 渲染**：完全支持格式化响应，包括：
  - 带语法高亮的代码块
  - 表格、列表和结构化内容
  - 粗体、斜体和标题样式
- **流式响应**：实时逐令牌响应显示
- **聊天历史**：在会话期间保持对话上下文

#### 3. **高级上下文感知** 🎯
- **编程上下文检测**：自动捕获：
  - 当前文件名和内容
  - 光标位置和行号
  - 编辑器中打开的文件
  - 选中的代码片段
- **右键集成**：上下文菜单操作"询问代码"用于选中的代码段
- **上下文响应**：根据您当前的编码环境定制答案

### F1：扩展功能 - 智能操作

#### 1. **智能单元测试生成** 🧪
**实现细节：**
- **交互式需求输入**：对话框提示使用自然语言输入特定测试场景
- **支持的场景示例**：
  - "测试空值"
  - "验证边界条件"
  - "测试异常处理"
  - "使用空输入测试边缘情况"
- **JUnit 5 兼容**：生成现代 JUnit 测试类，包含：
  - 适当的注解（@Test、@BeforeEach、@AfterEach）
  - 断言方法
  - 测试方法命名约定
- **智能测试放置**：自动在同一包中创建测试文件

**使用方法：**
1. 右键单击任何 Java 类或方法
2. 选择"CodePilot > 生成单元测试"
3. 描述测试场景（例如，"测试用户 ID 不存在时"）
4. 审查并确认生成的测试

#### 2. **Git 提交消息生成器** 📝
**实现细节：**
- **全面的差异分析**：使用 `git diff --cached` 捕获暂存的更改
- **语义意图检测**：分析代码更改以识别：
  - Bug 修复
  - 新功能
  - 重构
  - 文档更新
- **约定式提交格式**：生成遵循最佳实践的消息：
  ```
  type(scope): 简要描述
  
  - 详细更改 1
  - 详细更改 2
  
  BREAKING CHANGE: 如果适用
  ```
- **统计集成**：包含更改指标（更改的文件、插入、删除）

**使用方法：**
1. 使用 `git add` 暂存您的更改
2. 在 VCS 菜单中点击"生成提交消息"
3. 审查生成的消息
4. 消息自动填充到提交对话框或复制到剪贴板

#### 3. **创意功能：AI 驱动的代码生成** 🚀
**我们的创新补充：**
- **自然语言转代码**：从描述生成完整的代码实现
- **上下文感知生成**：理解当前类结构和插入点
- **智能代码放置**：
  - 检测光标是否在类或方法内部
  - 相应调整生成的代码格式
  - 保持适当的缩进和格式
- **实时预览**：在插入前显示生成的代码，带语法高亮
- **重新生成选项**：使用"重新生成"按钮优化结果

**使用方法：**
1. 将光标放在要插入代码的位置
2. 右键单击并选择"CodePilot > 生成代码"
3. 描述您想要的内容（例如，"创建用于用户身份验证的 REST 端点"）
4. 预览并插入生成的代码

## 🏗️ 技术架构

### 系统组件

```
CodePilot 插件架构
├── 服务层
│   ├── LLMService（DashScope AI 集成）
│   ├── RAGService（知识检索）
│   ├── VectorStoreService（嵌入和搜索）
│   └── DocumentProcessorService（内容提取）
├── UI 层
│   ├── CodePilotToolWindow（主聊天界面）
│   ├── MarkdownRenderer（富文本显示）
│   ├── SettingsDialog（配置）
│   └── Action Dialogs（测试、代码生成）
├── 操作
│   ├── AskAboutCodeAction
│   ├── GenerateUnitTestAction
│   ├── GenerateCommitMessageAction
│   └── GenerateCodeAction
└── 工具
    ├── ConfigManager（设置管理）
    ├── PromptLoader（模板管理）
    ├── CodeCleanupUtil（响应处理）
    └── KnowledgeBaseLoader（持久化）
```

### RAG 实现细节

#### 文档处理流程
1. **多格式支持**：PDF、DOCX、TXT、PPTX
2. **智能分块策略**：
   - PDF：逐页提取
   - DOCX：基于逻辑部分的分块（20 段/块）
   - PPTX：逐幻灯片处理
   - TXT：基于行的分块（50 行/块）

#### 向量搜索和检索
- **嵌入模型**：DashScope text-embedding-v2
- **相似度指标**：余弦相似度，可配置阈值
- **回退策略**：API 不可用时基于 TF-IDF 的嵌入
- **批量处理**：高效地为大型文档生成嵌入

#### 知识库结构
```json
{
  "chunkId": "Lec-01_p5_c1",
  "content": "提取的文本内容...",
  "embedding": [0.123, -0.456, ...],
  "source": "Lec-01-Introduction-to-Java.pdf",
  "page": 5,
  "documentType": "pdf"
}
```

### LLM 集成

#### 模型配置
- **主要模型**：阿里云 DashScope（qwen-plus）
- **流式支持**：实时令牌生成
- **上下文管理**：维护对话历史
- **错误处理**：优雅的回退，带用户通知

#### 提示工程
- **基于模板的系统**：不同功能的模块化提示
- **上下文注入**：动态包含：
  - RAG 检索的内容
  - 编程上下文
  - 代码片段
  - 用户需求
- **响应格式化**：带引用的结构化输出

## 🚀 安装与设置

### 先决条件
- IntelliJ IDEA 2025.1 或更高版本
- Java 21 或更高版本
- 启用 Git 集成

### 修改配置
1. 打开插件设置（CodePilot 窗口中的设置按钮）
2. 输入您的 DashScope API 密钥
3. 选择首选模型（默认：qwen-plus）

### 课程材料设置
插件自动处理来自以下位置的课程材料：
- `/src/main/resources/course_materials/`
- 支持的格式：PDF、DOCX、PPTX、TXT

### 持久化知识库与课程材料相关注意事项
- 初始时，插件知识库 `knowledge_base_with_embeddings.json` 存储在 `/src/main/resources/knowledge/`
- 如果修改了 `/src/main/resources/course_materials/` 下文件，请确保做到了以下事项：
  - 删除 `/src/main/resources/knowledge/` 下知识库
  - 确保 `/build/idea-sandbox/IC-2025.1.4.1/plugins/CodePilot/data/` 下没有知识库
  - 修改 `/src/main/resources/course_materials.txt`
  - 修改 `/src/main/java/com/codepilot/service/DocumentProcessorService.java:387` 中函数 `processDocumentsDirectly` 的局部变量 `knownFiles`

## 📖 使用指南

### 开始对话
1. 打开 CodePilot 工具窗口（右侧边栏）
2. 等待知识库初始化（准备就绪时显示块计数）
3. 输入您的问题并按 Enter 或点击发送
4. 使用 Shift+Enter 进行多行输入

### 获取上下文帮助
1. 在编辑器中选择代码
2. 右键单击 → "CodePilot" → "询问代码"
3. 输入您关于选中代码的问题
4. 接收带有课程材料引用的上下文感知解释

### 生成代码
1. 将光标放在所需位置
2. 右键单击 → "CodePilot" → "生成代码"
3. 用自然语言描述需求
4. 审查预览并点击"插入代码"

### 生成单元测试
1. 将光标放在所需位置
2. 右键单击 → "CodePilot" → "生成单元测试"
3. 用自然语言描述测试条件
4. 点击确认生成测试类

## 🔧 关键技术

- **IntelliJ Platform SDK**：插件开发框架
- **DashScope SDK**：LLM 和嵌入服务
- **Apache PDFBox 3.0**：PDF 文本提取
- **Apache POI 5.2**：Office 文档处理
- **Gson**：JSON 序列化
- **Java Swing**：UI 组件

## 📊 性能优化

- **智能缓存**：知识库持久化到磁盘
- **延迟加载**：按需处理文档
- **批量嵌入**：同时处理 25 个块
- **流式响应**：即时反馈，无需等待完整生成
- **增量渲染**：每 50 个字符更新一次 Markdown

## 🎯 设计理念

### 为什么选择页面级分块？
- 保持文档结构完整性
- 实现精确的源引用
- 平衡上下文窗口限制
- 提高检索准确性

### 为什么选择 Markdown 渲染？
- 更好的代码和结构化内容可读性
- 与开发者文档标准一致
- 支持富格式，无需外部依赖

## 📄 许可证

本项目作为 Java 企业应用开发课程作业。